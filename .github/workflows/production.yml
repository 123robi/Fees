name: Production deploy

on:
  push:
    branches: [ prod, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Production deployment
    steps:
    - name: SSH
      uses: fifsky/ssh-action@master
      with:
        command: |
          echo 'Connected to server, starting deployment'
          cd Fees
          sh -x ./docker/deploy.sh prod.yml
          sudo docker-compose -f prod.yml run --rm drf python manage.py migrate --run-syncdb
          sudo echo '---------- Docker compose migrate complete ----------'
          sudo echo '---------- Docker compose collectstatic started ----------'
          sudo docker-compose -f prod.yml run --rm drf python manage.py collectstatic --noinput
          echo 'Connected to server, finishing deployment'
        host: ${{ secrets.PRODUCTION_IP }}
        user: ubuntu
        key: ${{ secrets.PRODUCTION_PRIVATE_KEY}}
        args: "-tt -vvv"
